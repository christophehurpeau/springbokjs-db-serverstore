{"version":3,"sources":["../src/server.js"],"names":[],"mappings":"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","file":"src/server.js","sourcesContent":["var y = require('yielded');\n\nexports.initialize = function(io, serverStore) {\n    io.on('connection', function(socket) {\n        var openCursors = {}, timeouts = {}, activeListeners = {};\n\n        socket.on('disconnect', function() {\n            Object.keys(openCursors).forEach((cursorKey) => {\n                openCursors[cursorKey].close();\n            });\n            openCursors = null;\n\n            Object.keys(timeouts).forEach((timeoutKey) => {\n                clearTimeout(timeouts[timeoutKey]);\n            });\n            timeouts = null;\n\n            Object.keys(activeListeners).forEach((activeListenerKey) => {\n                var activeListener = activeListeners[activeListenerKey];\n                activeListener.service.unsubscribe(activeListener.listeners);\n            });\n            activeListeners = null;\n        });\n\n        socket.on('connectedUser', function(response) {\n            var userRestService = serverStore.restService('user');\n            userRestService.findConnected(socket.connectedUser).then((user) => {\n                if (!user) {\n                    return response(null);\n                }\n                response(null, {\n                    connected: socket.connectedUser,\n                    user: userRestService.transform(user)\n                });\n            }).catch((err) => response(err));\n        });\n\n        var nextIdCursor = 1;\n        socket.on('db cursor', function(dbName, modelName, query, options, response) {\n            var idCursor = nextIdCursor++;\n            var restService = serverStore.restService(modelName);\n            if (!restService) {\n                response(null);\n                throw new Error('restService missing: ' + modelName);\n            }\n            query = restService.query(socket.connectedUser, query);\n            restService.service.findAll().query(query).cursor().then((cursor) => {\n                if (!cursor) {\n                    return response();\n                }\n                // TODO cursor.isEmpty()\n                var count = cursor.count().then((count) => {\n                    // console.log(idCursor, 'count = ', count);\n                    if (!count) {\n                        cursor.close();\n                        return response(null);\n                    }\n                    var closeCursor = function() {\n                        cursor.close();\n                        delete openCursors[idCursor];\n                        delete timeouts[idCursor];\n                        socket.removeAllListeners('db cursor ' + idCursor);\n                    };\n\n                    var closeTimeout = setTimeout(function() {\n                        console.log('cursor closed by timeout ' + idCursor);\n                        closeCursor();\n                    }, 5 * 60 * 1000);\n                    openCursors[idCursor] = cursor;\n                    timeouts[idCursor] = closeTimeout;\n\n                    // TODO timeouts\n                    socket.on('db cursor ' + idCursor, (instruction, response) => {\n                        console.log('db cursor ' + idCursor + ' ' + instruction);\n                        if (instruction === 'next') {\n                            cursor.next().then((key) => {\n                                if (!key) {\n                                    return response(null);\n                                }\n                                return cursor.result().then((data) => {\n                                    response(null, restService.transform(data));\n                                });\n                            }, () => {\n                                response(null);\n                            });\n                        } else if (instruction === 'forEach') {\n                            cursor.forEachResults(function(result) {\n                                socket.emit('db cursor forEach ' + idCursor, result && restService.transform(result));\n                            }).then(function() {\n                                response(null);\n                            });\n                        } else if (instruction === 'close') {\n                            clearTimeout(closeTimeout);\n                            closeCursor();\n                            response(null);\n                        } else if (instruction === 'advance') {\n                            cursor.advance().then(() => response(null));\n                        }\n                    });\n                    return response(null, idCursor);\n                });\n            });\n        });\n\n        socket.on('db findOne', function(dbName, modelName, query, options, response) {\n            var restService = serverStore.restService(modelName);\n            query = restService.query(socket.connectedUser, query);\n            y.promise(restService.service.findOne().query(query).fetch()).then((vo) => {\n                response(null, vo && restService.transform(vo.data));\n            }).catch((err) => {\n                console.log(err.stack);\n                response(err);\n            });\n        });\n\n        socket.on('db insert', function(dbName, modelName, data, response) {\n            var restService = serverStore.restService(modelName);\n            var vo = restService.service.createNewVO(data);\n            vo = restService.prepareInsert(socket.connectedUser, vo);\n            y.promise(restService.service.insert(vo)).then(() => {\n                response(null, restService.transform(vo.data));\n            }).catch((err) => {\n                response(err);\n            });\n        });\n\n        var nextIdListener = 1;\n        socket.on('subscribe', function(dbName, modelName, query, response) {\n            var idListener = nextIdListener++;\n            var restService = serverStore.restService(modelName);\n            var listeners = {\n                query: restService.query(socket.connectedUser, query),\n                inserted: function(vo) {\n                    console.log('sending insert', idListener);\n                    socket.emit(idListener + ' event', { type: 'inserted', data: restService.transform(vo.data)});\n                },\n                updated: function(vo) {\n                    console.log('sending update', idListener);\n                    socket.emit(idListener + ' event', { type: 'updated', data: restService.transform(vo.data) });\n                },\n                deleted: function(vo) {\n                    console.log('sending delete', idListener);\n                    socket.emit(idListener + ' event', { type: 'deleted', data: restService.transform(vo.data) });\n                },\n            };\n            console.log('scoket subscribing ', listeners);\n            restService.service.subscribe(listeners);\n            activeListeners[idListener] = { service: restService.service, listeners: listeners };\n            socket.on('unsubscribe ' + idListener, function(response) {\n                console.log('scoket unsubscribing ', listeners);\n                restService.service.unsubscribe(listeners);\n                delete activeListeners[idListener];\n                response(null);\n            });\n            response(null, idListener);\n        });\n    });\n};\n"]}